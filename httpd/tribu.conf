
<VirtualHost *:443>
    ServerName tribu.local

    SSLEngine on

    SSLCertificateFile /etc/ssl/certs/server.crt
    SSLCertificateKeyFile /etc/ssl/certs/server.key

    ProxyPreserveHost On
    RewriteEngine On
    RewriteOptions Inherit

    DirectoryIndex /portal_2/tribu-app

    ProxyPass /nuxeo http://nuxeo:8080/nuxeo
    ProxyPassReverse /nuxeo  http://nuxeo:8080/nuxeo

    ProxyPass /cas http://cas:8080/cas
    ProxyPassReverse /cas  http://cas:8080/cas

    ProxyPass      /portal                          http://portal:8080/portal
    ProxyPassMatch ^/(.+)/(.*)-adapt-.*\.(css|js)$  http://portal:8080/$1/$2.$3
    ProxyPassMatch ^/(foad(-[a-z])+.*)$             http://portal:8080/$1
    ProxyPassMatch ^/(portal(-[a-z])+.*)$           http://portal:8080/$1
    ProxyPassMatch ^/(osivia(-[a-z])+.*)$           http://portal:8080/$1
    ProxyPassMatch ^/(toutatice(-[a-z])+.*)$        http://portal:8080/$1

    # Portal V2 sur poste local
    ProxyPass /portal_v2/tribu-app http://dev.local:4200
    ProxyPassReverse /portal_v2/tribu-app http://dev.local:4200
    ProxyPass /portal_v2/tribu-backend-controller http://dev.local:8080
    ProxyPassReverse /portal_v2/tribu-backend-controller http://dev.local:8080

    SetEnvIf Host (.*) the_host=$1
    RequestHeader set osivia-virtual-host "https://%{the_host}e"
    RequestHeader set nuxeo-virtual-host "https://%{the_host}e/"
    RequestHeader set X-Forwarded-Proto "https"


    # ---- Paramétrage location /portal_v2
    <Location /portal_v2>
        Require all granted
        SetEnvIf Host "^(.*)$" THE_HOST=$1
        # Si pas de proto, ajout https par défaut
        SetEnvIf X-Forwarded-Proto ^$ no_proto
        RequestHeader set X-Forwarded-Proto https env=no_proto
        # Si pas de host, ajout du host appelant  par défaut
        SetEnvIf X-Forwarded-Host ^$ no_host
        RequestHeader set X-Forwarded-Host %{THE_HOST}e env=no_host
        # Ajout location après url du host
        RequestHeader edit X-Forwarded-Host (.*) $1/portal_v2
        ProxyAddHeaders Off

        Header set Content-Security-Policy: "Allow-Origin https://collabora.tribu.local; frame-ancestors https://tribu.local; frame-src https://collabora.tribu.local;"
        #Header add Access-Control-Allow-Origin "https://collabora.tribu.local"
    </Location>


    <Location /onlyoffice>

        Require all granted
        SetEnvIf Host "^(.*)$" THE_HOST=$1

        # Si pas de proto, ajout https par défaut
        SetEnvIf X-Forwarded-Proto ^$ no_proto
        RequestHeader set X-Forwarded-Proto https env=no_proto

        # Si pas de host, ajout du host appelant  par défaut
        SetEnvIf X-Forwarded-Host ^$ no_host
        RequestHeader set X-Forwarded-Host %{THE_HOST}e env=no_host

        # Ajout location après url du host
        RequestHeader edit X-Forwarded-Host (.*) $1/onlyoffice
        ProxyAddHeaders Off
    </Location>

    ProxyPassMatch ^\/onlyoffice(.*)(\/websocket)$ "ws://OO_HOST$1$2"
    ProxyPass /onlyoffice "http://OO_HOST"
    ProxyPassReverse /onlyoffice "http://OO_HOST"


</VirtualHost>
